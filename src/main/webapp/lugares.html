<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lugares - Cocina Social</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/common.css">
    <link rel="stylesheet" href="assets/css/lugares.css">
</head>
<body class="bg-gray-50">

    <!-- Navigation -->
    <nav class="bg-white shadow-lg fixed w-full top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-utensils text-3xl text-purple-600 mr-3"></i>
                    <span class="text-2xl font-bold text-purple-600">Cocina Social</span>
                </div>
                <div class="hidden md:flex space-x-8">
                    <a href="home.html" class="text-gray-700 hover:text-purple-600 transition">Inicio</a>
                    <a href="recetas.html" class="text-gray-700 hover:text-purple-600 transition">Recetas</a>
                    <a href="lugares.html" class="text-pink-600 font-semibold">Lugares</a>
                    <a href="comunidad.html" class="text-gray-700 hover:text-purple-600 transition">Comunidad</a>
                </div>
                <div class="flex space-x-3" id="nav-buttons"></div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="pt-24 pb-12 gradient-bg text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">游늸 Descubre Lugares Incre칤bles</h1>
            <p class="text-xl text-pink-100">Los mejores restaurantes recomendados por la comunidad</p>
        </div>
    </div>

    <!-- Filters & Search -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-6 mb-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="grid md:grid-cols-4 gap-4">
                <input type="text" id="search-input" placeholder="游댌 Buscar lugares..."
                       class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-600"
                       onkeypress="if(event.key === 'Enter') loadLugares()">
                <input type="text" id="filter-ciudad" placeholder="Ciudad"
                       class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-600"
                       onkeypress="if(event.key === 'Enter') loadLugares()">
                <button onclick="loadLugares()" class="px-6 py-3 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition">
                    <i class="fas fa-search mr-2"></i> Buscar
                </button>
                <button onclick="showCreateModal()" id="btn-crear-lugar" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                    <i class="fas fa-plus mr-2"></i> Recomendar Lugar
                </button>
            </div>
        </div>
    </div>

    <!-- Lugares Grid -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-20">
        <div id="lugares-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="col-span-3 text-center py-12">
                <i class="fas fa-spinner fa-spin text-4xl text-pink-600 mb-4"></i>
                <p class="text-gray-600">Descubriendo lugares incre칤bles...</p>
            </div>
        </div>
    </div>

    <!-- Modal Crear/Editar Lugar -->
    <div id="lugar-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full p-8 relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeLugarModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>

            <h3 class="text-3xl font-bold text-gray-900 mb-6">
                <i class="fas fa-map-marker-alt text-pink-600 mr-2"></i>
                <span id="modal-title">Recomendar Lugar</span>
            </h3>

            <form id="lugar-form" class="space-y-4">
                <input type="hidden" id="lugar-id">

                <div>
                    <label class="block text-gray-700 mb-2 font-medium">Nombre del Lugar *</label>
                    <input type="text" id="lugar-nombre" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-600">
                </div>

                <div>
                    <label class="block text-gray-700 mb-2 font-medium">Direcci칩n Completa *</label>
                    <textarea id="lugar-direccion" required rows="3"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-600"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">Ciudad</label>
                        <input type="text" id="lugar-ciudad"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">Pa칤s</label>
                        <input type="text" id="lugar-pais"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-600">
                    </div>
                </div>

                <button type="submit"
                        class="w-full py-3 bg-gradient-to-r from-pink-600 to-rose-600 text-white rounded-lg font-semibold hover:from-pink-700 hover:to-rose-700 transition">
                    <i class="fas fa-save mr-2"></i> Guardar Lugar
                </button>
            </form>
        </div>
    </div>

    "usuarioId": {{ user_id }},
    "texto": "Delicioso",
    "recetaId": 9    <!-- Modal Ver Lugar -->
    <div id="ver-lugar-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full p-8 relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeVerLugarModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>

            <div id="lugar-detalle-content">
                <!-- El contenido se cargar치 din치micamente -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer"></div>

    <!-- Modal de Login -->
    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-8 relative">
            <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h3 class="text-3xl font-bold text-gray-900 mb-6">Iniciar Sesi칩n</h3>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2 font-medium">Usuario o Email</label>
                    <input type="text" id="login-username" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2 font-medium">Contrase침a</label>
                    <input type="password" id="login-password" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                </div>
                <button type="submit"
                        class="w-full py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-indigo-700 transition">
                    Iniciar Sesi칩n
                </button>
            </form>
            <p class="mt-4 text-center text-gray-600">
                쯅o tienes cuenta?
                <button onclick="switchToRegister()" class="text-purple-600 font-semibold hover:underline">
                    Reg칤strate
                </button>
            </p>
        </div>
    </div>

    <!-- Modal de Registro -->
    <div id="register-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-8 relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeRegisterModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h3 class="text-3xl font-bold text-gray-900 mb-6">Crear Cuenta</h3>
            <form id="register-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">Nombre</label>
                        <input type="text" id="register-nombre"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">Apellido</label>
                        <input type="text" id="register-apellido"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                    </div>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2 font-medium">Usuario *</label>
                    <input type="text" id="register-username" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2 font-medium">Email *</label>
                    <input type="email" id="register-email" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2 font-medium">Contrase침a *</label>
                    <input type="password" id="register-password" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                </div>
                <button type="submit"
                        class="w-full py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-indigo-700 transition">
                    Crear Cuenta
                </button>
            </form>
            <p class="mt-4 text-center text-gray-600">
                쯏a tienes cuenta?
                <button onclick="switchToLogin()" class="text-purple-600 font-semibold hover:underline">
                    Inicia sesi칩n
                </button>
            </p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-white shadow-2xl rounded-lg p-4 max-w-sm z-50">
        <div class="flex items-center">
            <div id="toast-icon" class="mr-3"></div>
            <div>
                <p id="toast-message" class="font-semibold text-gray-900"></p>
                <p id="toast-detail" class="text-sm text-gray-600"></p>
            </div>
        </div>
    </div>

    <script src="assets/js/components.js"></script>
    <script src="assets/js/auth-modal.js"></script>
    <script src="assets/js/csrf-protection.js"></script>
    <script>
        Components.loadFooter();

        let currentLugarId = null;

        // ========================================
        // FUNCIONES DE SEGURIDAD - PREVENCI칍N XSS
        // ========================================

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function sanitizeNumber(value) {
            const num = parseInt(value);
            return isNaN(num) ? 0 : num;
        }

        // Verificar si el usuario es admin
        function isAdmin() {
            const user = getUser();
            return user && user.role === 'ADMIN';
        }

        function checkAuthForCreate() {
            const btnCrear = document.getElementById('btn-crear-lugar');
            const user = getUser();
            if (!user) {
                btnCrear.classList.add('hidden');
            }
        }

        function showCreateModal() {
            const user = getUser();
            if (!user) {
                showToast('Debes iniciar sesi칩n', 'Reg칤strate o inicia sesi칩n para recomendar lugares', 'info');
                openLoginModal();
                return;
            }

            document.getElementById('modal-title').textContent = 'Recomendar Lugar';
            document.getElementById('lugar-form').reset();
            document.getElementById('lugar-id').value = '';
            currentLugarId = null;
            document.getElementById('lugar-modal').classList.remove('hidden');
        }

        function closeLugarModal() {
            document.getElementById('lugar-modal').classList.add('hidden');
        }

        // Ver detalles de lugar
        async function verLugar(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/lugares/${id}`);
                const lugar = await response.json();

                if (response.ok) {
                    const user = getUser();
                    const canEdit = user && (lugar.autorId === user.id || isAdmin());

                    const content = `
                        <div class="mb-6">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <h3 class="text-3xl font-bold text-gray-900 mb-2">
                                        <i class="fas fa-map-marker-alt text-pink-600 mr-2"></i>
                                        ${escapeHtml(lugar.nombre)}
                                    </h3>
                                </div>
                            </div>

                            <div class="space-y-3 mb-4">
                                <div class="flex items-start">
                                    <i class="fas fa-map-pin text-pink-600 mr-3 mt-1 text-lg"></i>
                                    <div>
                                        <p class="text-gray-700 font-medium">Direcci칩n</p>
                                        <p class="text-gray-600">${escapeHtml(lugar.direccion)}</p>
                                    </div>
                                </div>

                                ${lugar.ciudad ? `
                                    <div class="flex items-start">
                                        <i class="fas fa-city text-pink-600 mr-3 mt-1 text-lg"></i>
                                        <div>
                                            <p class="text-gray-700 font-medium">Ciudad</p>
                                            <p class="text-gray-600">${escapeHtml(lugar.ciudad)}${lugar.pais ? ', ' + escapeHtml(lugar.pais) : ''}</p>
                                        </div>
                                    </div>
                                ` : ''}

                                <div class="flex items-start">
                                    <i class="far fa-user text-pink-600 mr-3 mt-1 text-lg"></i>
                                    <div>
                                        <p class="text-gray-700 font-medium">Recomendado por</p>
                                        <p class="text-gray-600">${escapeHtml(lugar.autorUsername) || 'An칩nimo'}</p>
                                    </div>
                                </div>
                            </div>

                            ${canEdit ? `
                                <div class="flex space-x-3 pt-4 border-t">
                                    <button onclick="closeVerLugarModal(); editLugar(${sanitizeNumber(lugar.id)})"
                                            class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold">
                                        <i class="fas fa-edit mr-2"></i> Editar Lugar
                                    </button>
                                    <button onclick="closeVerLugarModal(); deleteLugar(${sanitizeNumber(lugar.id)})"
                                            class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">
                                        <i class="fas fa-trash mr-2"></i> Eliminar
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;

                    document.getElementById('lugar-detalle-content').innerHTML = content;
                    document.getElementById('ver-lugar-modal').classList.remove('hidden');
                } else {
                    showToast('Error', 'No se pudo cargar el lugar', 'error');
                }
            } catch (error) {
                console.error('Error al cargar lugar:', error);
                showToast('Error', 'No se pudo cargar el lugar', 'error');
            }
        }

        function closeVerLugarModal() {
            document.getElementById('ver-lugar-modal').classList.add('hidden');
        }

        async function loadLugares() {
            const grid = document.getElementById('lugares-grid');
            grid.innerHTML = '<div class="col-span-3 text-center py-12"><i class="fas fa-spinner fa-spin text-4xl text-pink-600"></i></div>';

            try {
                // Obtener valores de b칰squeda y filtros
                const searchTerm = document.getElementById('search-input').value.trim();
                const ciudadFilter = document.getElementById('filter-ciudad').value.trim();

                const response = await fetch(`${API_BASE_URL}/lugares`);
                let lugares = await response.json();

                // Aplicar filtro de b칰squeda por texto
                if (searchTerm) {
                    lugares = lugares.filter(lugar =>
                        lugar.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (lugar.direccion && lugar.direccion.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (lugar.ciudad && lugar.ciudad.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (lugar.pais && lugar.pais.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                }

                // Aplicar filtro por ciudad
                if (ciudadFilter) {
                    lugares = lugares.filter(lugar =>
                        lugar.ciudad && lugar.ciudad.toLowerCase().includes(ciudadFilter.toLowerCase())
                    );
                }

                if (lugares.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-3 text-center py-12">
                            <i class="fas fa-map-marked-alt text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-600 text-lg">No hay lugares recomendados a칰n.</p>
                            <p class="text-gray-500">춰Comparte tu lugar favorito!</p>
                        </div>
                    `;
                    return;
                }

                const user = getUser();

                grid.innerHTML = lugares.map(lugar => {
                    const canEdit = user && (lugar.autorId === user.id || isAdmin());
                    return `
                        <div class="lugar-card bg-white rounded-2xl shadow-lg overflow-hidden cursor-pointer hover:shadow-2xl transition-shadow duration-300"
                             onclick="verLugar(${sanitizeNumber(lugar.id)})">
                            <div class="h-40 bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center">
                                <i class="fas fa-map-marker-alt text-white text-5xl"></i>
                            </div>
                            <div class="p-6">
                                <h3 class="text-xl font-bold text-gray-900 mb-2">${escapeHtml(lugar.nombre)}</h3>
                                <p class="text-gray-600 mb-2 flex items-start">
                                    <i class="fas fa-map-pin text-pink-600 mr-2 mt-1"></i>
                                    <span>${escapeHtml(lugar.direccion)}</span>
                                </p>
                                ${lugar.ciudad ? `
                                    <p class="text-sm text-gray-500 mb-4">
                                        <i class="fas fa-city mr-2"></i>${escapeHtml(lugar.ciudad)}${lugar.pais ? ', ' + escapeHtml(lugar.pais) : ''}
                                    </p>
                                ` : ''}
                                <p class="text-xs text-gray-400 mb-4">
                                    <i class="far fa-user mr-1"></i> Recomendado por: ${escapeHtml(lugar.autorUsername) || 'An칩nimo'}
                                </p>
                                ${canEdit ? `
                                    <div class="flex space-x-2">
                                        <button onclick="event.stopPropagation(); editLugar(${sanitizeNumber(lugar.id)})"
                                                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                            <i class="fas fa-edit mr-1"></i> Editar
                                        </button>
                                        <button onclick="event.stopPropagation(); deleteLugar(${sanitizeNumber(lugar.id)})"
                                                class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                                            <i class="fas fa-trash mr-1"></i> Eliminar
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                showToast('Lugares cargados', `${lugares.length} lugar(es) encontrado(s)`);
            } catch (error) {
                grid.innerHTML = '<div class="col-span-3 text-center py-12"><p class="text-red-600">Error al cargar lugares</p></div>';
                showToast('Error', 'No se pudieron cargar los lugares', 'error');
            }
        }

        document.getElementById('lugar-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const user = getUser();
            if (!user) {
                showToast('Error', 'Debes iniciar sesi칩n', 'error');
                return;
            }

            const payload = {
                nombre: document.getElementById('lugar-nombre').value,
                direccion: document.getElementById('lugar-direccion').value,
                ciudad: document.getElementById('lugar-ciudad').value || undefined,
                pais: document.getElementById('lugar-pais').value || undefined,
                autorId: user.id
            };

            console.log('Payload a enviar:', JSON.stringify(payload, null, 2));

            try {
                const url = currentLugarId
                    ? `${API_BASE_URL}/lugares/${currentLugarId}`
                    : `${API_BASE_URL}/lugares`;
                const method = currentLugarId ? 'PUT' : 'POST';

                const response = await CsrfProtection.protectedFetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('춰칄xito!', `Lugar ${currentLugarId ? 'actualizado' : 'creado'} correctamente`, 'success');
                    closeLugarModal();
                    loadLugares();
                } else {
                    showToast('Error', data.error || data.message || 'Error al guardar', 'error');
                }
            } catch (error) {
                console.error('Error al guardar lugar:', error);
                showToast('Error', 'No se pudo guardar el lugar', 'error');
            }
        });

        async function editLugar(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/lugares/${id}`);
                const lugar = await response.json();

                if (response.ok) {
                    document.getElementById('modal-title').textContent = 'Editar Lugar';
                    document.getElementById('lugar-id').value = lugar.id;
                    document.getElementById('lugar-nombre').value = lugar.nombre;
                    document.getElementById('lugar-direccion').value = lugar.direccion;
                    document.getElementById('lugar-ciudad').value = lugar.ciudad || '';
                    document.getElementById('lugar-pais').value = lugar.pais || '';
                    currentLugarId = id;
                    document.getElementById('lugar-modal').classList.remove('hidden');
                }
            } catch (error) {
                showToast('Error', 'No se pudo cargar el lugar', 'error');
            }
        }

        async function deleteLugar(id) {
            if (!confirm('쮼st치s seguro de eliminar este lugar?')) return;

            try {
                const response = await CsrfProtection.protectedFetch(`${API_BASE_URL}/lugares/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('Eliminado', 'Lugar eliminado correctamente', 'success');
                    loadLugares();
                } else {
                    showToast('Error', 'No se pudo eliminar el lugar', 'error');
                }
            } catch (error) {
                showToast('Error', 'No se pudo eliminar el lugar', 'error');
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            checkAuthForCreate();
            loadLugares();
        });
    </script>
</body>
</html>

